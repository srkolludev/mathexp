{"version":3,"sources":["api/question/question.controller.js"],"names":["getQns","getQnsByUserId","getQnByQnId","setQnHistory","getQnsBySchemeParams","getEndUserQnsBySctId","getEndUserQnsByQnId","getQnsBySearchParams","create","upsert","deleteQn","auth","util","require","async","validationError","res","statusCode","err","status","json","respondWithResult","entity","handleError","send","removeEntity","remove","then","end","handleEntityNotFound","req","find","exec","catch","userId","user","_id","console","log","role","exclude","session","id","qnId","params","qnOption","opt","undefined","filter","grade","body","waterfall","callback","lookups","subCatlist","Array","sctGrdArr","lkups","sct_grd","si","length","grd","push","parseInt","sct","level","$in","handleEndUserQuestions","result","qnSctId","query","qns","error","qnCntRetVal","message","timeSpan","userTimespan","totalTimespanQns","i","j","Math","floor","random","temp","qi","et","splice","skipqns","evaluateQuestion","err2","anhi","getEvalDataFromHistory","newqns","isErronousQuestion","replaceQuestionWithEvaluatedData","err3","qj","getEvalDataFromEval","getMulitpleChoiceFromEval","typ","usecase","drng","getChoiceObj","getChoices","ans","mtch","parseEqnObj","parseEquation","eqn","evda","Error","max","rnd","evhi","mthi","writeEvalDataToHistory","cleanEndUserQuestion","cleanEditorQuestion","k","desc","p","replace","replacer","match","$1","$2","trim","steps","searchObj","fieldName","field","fieldValue","value","findOneAndUpdate","new","setDefaultsOnInsert","runValidators","qn","Question"],"mappings":"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","file":"question.controller.js","sourcesContent":["'use strict';\n\nimport Question from './question.model';\nimport User from '../../api/user/user.model';\nimport * as auth from '../../auth/auth.service';\nimport compose from 'composable-middleware';\n//core business objects\nimport EvalObj from '../../core/evaluate';\nimport Lookups from '../lookups/lookups.model';\n\nconst util = require('util');\nvar async = require(\"async\");\n\nfunction validationError(res, statusCode) {\n  statusCode = statusCode || 422;\n  return function (err) {\n    return res.status(statusCode).json(err);\n  };\n}\n\nfunction respondWithResult(res, statusCode) {\n  statusCode = statusCode || 200;\n  return function (entity) {\n    if (entity) {\n      return res.status(statusCode).json(entity);\n    }\n    return null;\n  };\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function (err) {\n    return res.status(statusCode).send(err);\n  };\n}\n\n\nfunction removeEntity(res) {\n  return function (entity) {\n    if (entity) {\n      return entity.remove()\n        .then(() => {\n          res.status(204).end();\n        });\n    }\n  };\n}\n\nfunction handleEntityNotFound(res) {\n  return function (entity) {\n    if (!entity) {\n      res.status(404).end();\n      return null;\n    }\n    return entity;\n  };\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function (err) {\n    res.status(statusCode).send(err);\n  };\n}\n\nexport function getQns(req, res) {\n  return Question.find({\"updatedAt\" : {\"$gt\" :\"2017-08-01T03:41:55.032Z\"}}).exec()\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\n/**\n * getQnsByUserId\n */\n//off line mode send back every thing except histories,cu,mu,cd, sort by md\nexport function getQnsByUserId(req, res) {\n var userId = req.user._id;\n  console.log('Authenticated: userId -' + req.user.role)\n  var exclude = \"-evhi -mthi -anhi\";\n  /*\n  if (req.user.role == \"master\") {\n    exclude = \"-evhi -mthi\"\n  }\n  else if (req.user.role == \"admin\") {\n    exclude = \"-evhi -mthi\"\n  }\n  */\n\n    return Question.find({\"updatedAt\" : {\"$gt\" :\"2017-08-01T03:41:55.032Z\"}}).exec()\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n    /*\n  return Question.find({ cu: userId }, exclude).exec()\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n    */\n}\n\n/**\n * getQnsByUserId\n */\nexport function getQnByQnId(req, res) {\n  console.log(\"session id:\" + req.session.id);\n  var qnId = req.params.id;\n  var qnOption = req.params.opt;\n  //1  edit Question  -evhi -mthi -anhi another idea bring every thing and populate with latest evda, mtch, ans\n  //2  test Question (same as enduser)  -evhi -mthi -anhi\n  //3  build History Question (same as enduser + save history + get all last history evda, mtch, ans)\n  //4  post question (history manipulation - history precedence)\n\n  if (req.params.opt == undefined) {\n    //generatte and provide\n    var exclude = \"-evhi -mthi -anhi -evda -eqn -drng\"\n    return Question.find({ _id: qnId }).exec()\n      .then(respondWithResult(res))\n      .catch(handleError(res));\n\n    //update the history sequence id and session id\n    //\n    //do not repeat the same data in the same session\n  }\n  else {\n    if (req.params.opt == 1) {\n      return Question.find({ _id: qnId }).exec()\n        .then(respondWithResult(res))\n        .catch(handleError(res));\n    }\n  }\n  // console.log('qustion Id -' + qnId)\n  // var excludeOpt1 = \"-evhi -mthi -anhi\";\n  // var excludeOpt2 = \"-evhi -mthi -anhi\";\n  //var excludeOpt1 = \"-evhi -mthi -anhi\";\n\n  // console.log('qns sctid get dberror...' + req.params.id);\n  //var query = Question.find({ _id: qnId });\n  /*\n  return Question.find({ _id: qnId }, exclude).exec()\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n */\n  //test question from editor or generare history from editor\n\n\n  //refresh question from user\n}\n\n\n/**\n * getQnsByUserId\n */\nexport function setQnHistory(req, res) {\n  var qnId = req.params.id;\n  var qnOption = req.params.opt;\n  //1 get for the enduser -- by deafault\n  //2 \n  //3\n\n  if (req.params.opt == undefined) {\n    //generatte and provide\n    return Question.find({ _id: qnId }, exclude).exec()\n      .then(respondWithResult(res))\n      .catch(handleError(res));\n  }\n  else {\n    return Question.find({ _id: qnId }).exec()\n      .then(respondWithResult(res))\n      .catch(handleError(res));\n  }\n  // console.log('qustion Id -' + qnId)\n  // var excludeOpt1 = \"-evhi -mthi -anhi\";\n  // var excludeOpt2 = \"-evhi -mthi -anhi\";\n  //var excludeOpt1 = \"-evhi -mthi -anhi\";\n\n  // console.log('qns sctid get dberror...' + req.params.id);\n  //var query = Question.find({ _id: qnId });\n  /*\n  return Question.find({ _id: qnId }, exclude).exec()\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n */\n  //test question from editor or generare history from editor\n\n\n  //refresh question from user\n\n\n}\n//db.getCollection('lookups').find({},{\"lkups.lvl\":1, _id:0})\n//function getSubcatByGrade(grade) {\n//ifin cachse get from cache\n//console.log('getSubcatByGrade...' + grade);\n \n        //return subCatlist;\n    //});\n//}\n//db.getCollection('questions').find({\"lvl\": {\"$all\": [\"beg\", \"int\"]}}) --and\n//db.getCollection('questions').find({\"lvl\": {\"$in\": [\"beg\", \"adv\"]}}) --or\n//db.getCollection('questions').find({\"lvl\": {\"$in\": [\"beg\", \"adv\"]}, \"sct\": {\"$in\" : [1,3,\"4\",2]}})\nexport function getQnsBySchemeParams(req, res) {\n var filter = {};\n var grade = req.body.grade;\n  \nasync.waterfall([\n  function (callback) {\n      Lookups.find({},{\"lkups.sct_grd\":1, \"_id\":0}, (err, lookups) => {\n      if (err) {\n        res.status(500).send(err);\n      }\n      //res.json(lookups);\n      //console.log('..questions.find end...');\n         var subCatlist = new Array();\n      var sctGrdArr = lookups[0].lkups.sct_grd;\n      console.log('sctGrdArr:' + JSON.stringify(sctGrdArr));\n   \n          for (let si = 0; si < sctGrdArr.length; si++) {\n            if (sctGrdArr[si].grd == grade) {\n                subCatlist.push(parseInt(sctGrdArr[si].sct));\n            }\n          }\n        console.log(\"filter subCatlist: \" + JSON.stringify(subCatlist));\n      //  done(subCatlist);\n      callback(null,subCatlist);\n       });\n\n  },\n    function(subCatlist,callback){\n        // arg1 is equals 'a' and arg2 is 'b'\n        // Code c\n          filter[\"sct\"] = {};\n          filter[\"sct\"][\"$in\"] = subCatlist;\n          if (req.body.level == \"beg\" ) {\n              filter[\"lvl\"] = {};\n              filter[\"lvl\"][\"$in\"] =  [\"beg\",\"tal\"];\n          }\n          else if  (req.body.level == \"int\") {\n              filter[\"lvl\"] = \"int\";\n          }\n          else if  (req.body.level == \"adv\" ) {\n              filter[\"lvl\"] = {$in: [\"adv\",\"exp\"]};\n          }\n          else {\n            filter[\"lvl\"] = \"int\";\n          }\n        console.log(\"filter start: \" + JSON.stringify(filter));\n        handleEndUserQuestions(filter, req, res)\n        callback(null, \"ok\")\n    }], function (err, result) {\n      console.log(\"result:\" + result)\n        // result is 'd'    \n    });\n}\n/**\n * getQnsBySctId4\n * User Qns by Grade Sub Category\n * Not required to create history\n * 1 equation question, 2 simple question\n */\nexport function getEndUserQnsBySctId(req, res) {\n  var qnSctId = req.params.id;\n  var filter = {};\n  filter[\"sct\"] = qnSctId;\n  handleEndUserQuestions(filter, req, res);\n}\n\n//refresh question logic\nexport function getEndUserQnsByQnId(req, res) {\n  //console.log(util.inspect(req, {showHidden: false, depth: null}));\n // console.log(\"getEndUserQnsByQnId:\" + JSON.stringify(req));\n  var qnId = req.query.id;\n  var filter = {};\n  filter[\"_id\"] = qnId;\n  handleEndUserQuestions(filter, req, res);\n}\n\nfunction handleEndUserQuestions(filter, req, res) {\n  var qns;\n  var query = Question.find(filter);\n  query.exec(function (err, qns) {\n    if (err) {\n      console.log('qns get dberror...' + filter);\n      res.send(500, { error: err });\n    }\n  var qnCntRetVal = 0;\n\n  if (!qns)  {\n     res.status(200).send({message:\"no questions found\"});\n  }\n\n  if (req.body.timeSpan) {\n    //pick questions randomly under this time span\n    //shuffle the questions\n  \n    let userTimespan = parseInt(req.body.timeSpan) * 60;\n    let totalTimespanQns = 0;\n       console.log(\"userTimespan: \" + userTimespan);\n       //---------------shuffle array -----------\n       for (var i = qns.length - 1; i > 0; i--) {\n            var j = Math.floor(Math.random() * (i + 1));\n            var temp = qns[i];\n            qns[i] = qns[j];\n            qns[j] = temp;\n        }\n      //-------------------------------------------\n    //qns = shuffleArray(qns);\n      console.log(\"initial filtered questions from database : \" + qns.length);\n       for (let qi = 0; qi < qns.length; qi++) {\n         console.log(\"qn[\" + qi + \"]: time span\" + totalTimespanQns);\n         if (totalTimespanQns <= userTimespan) {\n          if (req.body.level == \"beg\" ) {\n              filter[\"lvl\"] = {$in: [\"beg\",\"tal\"]};\n              if (qns[qi].et[\"beg\"]) {\n                totalTimespanQns = totalTimespanQns + parseInt(qns[qi].et[\"beg\"]);\n              }\n              else if (qns[qi].et[\"tal\"]) {\n                totalTimespanQns = totalTimespanQns + parseInt(qns[qi].et[\"tal\"]);\n              }\n          }\n          else if  (req.body.level == \"int\" ) {\n                //console.log(\"time : \" + qns[qi].et[\"int\"]);\n                totalTimespanQns = totalTimespanQns + parseInt(qns[qi].et[\"int\"]);\n          }\n          else if  (req.body.level == \"adv\" ) {\n              if (qns[qi].et[\"exp\"]) {\n                totalTimespanQns = totalTimespanQns + parseInt(qns[qi].et[\"exp\"]);\n              }\n              else if (qns[qi].et[\"adv\"]) {\n                totalTimespanQns = totalTimespanQns + parseInt(qns[qi].et[\"exp\"]);\n              }\n          }\n         }\n         else {\n           qnCntRetVal = qi;\n           break;\n         }\n       }\n       qns = qns.splice(qnCntRetVal);\n       //TODO should need to consider removed questions if there are any erroneous in ecal process.\n  }\n    console.log(\"questions set after timer : \" + qns.length);\n    let skipqns = new Array;\n    for (let qi = 0; qi < qns.length; qi++) {\n      try {\n        evaluateQuestion(qns, qi);\n      } //end try\n      catch (err2) {\n        console.log('Qn failed at evaluateQuestion processing...' + JSON.stringify(qns[qi]));\n        console.log('error is...' + err2);\n        if (qns[qi].anhi) {\n          getEvalDataFromHistory(qns, qi);\n        }\n        else {\n          console.log('Qn skipped due to  NO history...');\n          skipqns.push(qi);\n          continue;\n        }\n      }\n    } //end of qns for\n    ////////////////////////////////////////////////////////\n   // if (skipqns.length > 0) {\n      let newqns = new Array;\n      for (let qi = 0; qi < qns.length; qi++) {\n        if (isErronousQuestion(qi, skipqns)) continue;\n        try {\n          replaceQuestionWithEvaluatedData(qns, qi);\n          //no error clean and add to newqns list\n         // cleanEndUserQuestion(qns, qi);\n          newqns.push(qns[qi]);\n        }\n        catch(err3)\n        {\n            console.log('Qn failed at replaceQuestionWithEvaluatedData processing...' + JSON.stringify(qns[qi]));\n            console.log('error is...' + err3);\n        }\n      }\n      //console.log('qns sctid get result...' + JSON.stringify(newqns));\n      res.json(newqns);\n      /*\n    }\n    else {\n      for (let qi = 0; qi < qns.length; qi++) {\n        replaceQuestionWithEvaluatedData(qns, qi);\n        cleanEndUserQuestion(qns, qi)\n      }\n      console.log('qns sctid get result...' + JSON.stringify(qns));\n      res.json(qns);\n    }\n    */\n  });  //end of query.exec\n}\n\nfunction isErronousQuestion(qi, skipqns) {\n  // if (skipqns.length == 0) return false;\n  for (let qj = 0; qj < skipqns.length; qj++)\n    if (qi == skipqns[qj]) return true;\n  return false;\n}\n\nfunction evaluateQuestion(qns, qi) {\n  getEvalDataFromEval(qns, qi);\n  getMulitpleChoiceFromEval(qns, qi);\n}\n\nfunction getMulitpleChoiceFromEval(qns, qi) {\n  if (qns[qi].typ == 1) {\n    if (qns[qi].usecase && qns[qi].usecase == 1) {  //user defined choices\n      //nothing\n    }\n    else {\n      var drng = qns[qi].drng ? qns[qi].drng : null;\n      var getChoiceObj = new EvalObj.getChoices(qns[qi].ans, drng);\n      qns[qi].mtch = getChoiceObj.mtch;\n    }\n  }\n  else if (qns[qi].typ == 2) {\n    var getChoiceObj = new EvalObj.getChoices(qns[qi].ans, {});\n    qns[qi].mtch = getChoiceObj.mtch;\n  }\n}\n\nfunction getEvalDataFromEval(qns, qi) {\n  if (qns[qi].typ != 1) return; //continue only for equation question type 1\n  var drng = qns[qi].drng ? qns[qi].drng : null;\n  var usecase = qns[qi].usecase ? qns[qi].usecase : null;\n  //console.log('qns sctid processing input eqn ...' + JSON.stringify(qn.eqn));\n  //console.log('qns sctid processing input drng ...' + JSON.stringify(drng));\n  var parseEqnObj = new EvalObj.parseEquation(qns[qi].eqn, drng, usecase);\n  //console.log('qns sctid equation output result...' + JSON.stringify(parseEqnObj));\n  if (parseEqnObj.evda = null) {\n    throw new Error(\"****evda is null****\")\n  }\n  qns[qi].evda = parseEqnObj.evda;\n  qns[qi].ans = parseEqnObj.ans;\n}\n\nfunction getEvalDataFromHistory(qns, qi) {\n  //tied to session later to avoid same eval data\n  let max = qns[qi].anhi.length;\n  let rnd = Math.floor(Math.random() * max);\n  qns[qi].ans = qns[qi].anhi[rnd];\n  qns[qi].evda = qns[qi].evhi[rnd];\n  qns[qi].mtch = qns[qi].mthi[rnd];\n}\n\n\nfunction writeEvalDataToHistory(qns, qi) {\n  //tied to session later to avoid same eval data\n  //delete previous history NULLs too\n  let max = qns[qi].anhi.length;\n  let rnd = Math.floor(Math.random() * max);\n  qns[qi].ans = qns[qi].anhi[rnd];\n  qns[qi].evda = qns[qi].evhi[rnd];\n  qns[qi].mtch = qns[qi].mthi[rnd];\n}\n\nfunction cleanEndUserQuestion(qns, qi) {\n  qns[qi].evda = undefined;\n  qns[qi].anhi = undefined;\n  qns[qi].evhi = undefined;\n  qns[qi].mthi = undefined;\n  qns[qi].drng = undefined;\n  qns[qi].eqn = undefined;\n}\n\nfunction cleanEditorQuestion(qns, qi) {\n  qns[qi].anhi = undefined;\n  qns[qi].evhi = undefined;\n  qns[qi].mthi = undefined;\n}\n\nfunction replaceQuestionWithEvaluatedData(qns, qi) {\n  for (let k = 0; k < qns[qi].desc.length; k++) {\n    qns[qi].desc[k].p = qns[qi].desc[k].p.replace(/\\[(.*?)=(.*?)\\]/g, function replacer(match, $1, $2) {\n      return (qns[qi].evda[$1.trim()] + \"\").trim();\n    });\n\n    qns[qi].desc[k].p = qns[qi].desc[k].p.replace(/\\[(.*?)\\]/g, function replacer(match, $1) {\n      return (qns[qi].evda[$1.trim()] + \"\").trim();\n    });\n  }\n\n  if (qns[qi].steps) {\n    for (let k = 0; k < qns[qi].steps.length; k++) {\n      //description\n      qns[qi].steps[k].desc = qns[qi].steps[k].desc.replace(/\\[(.*?)=(.*?)\\]/g, function replacer(match, $1, $2) {\n        return (qns[qi].evda[$1.trim()] == undefined ? $1.trim() : (qns[qi].evda[$1.trim()] + \"\").trim());\n      });\n\n      qns[qi].steps[k].desc = qns[qi].steps[k].desc.replace(/\\[(.*?)\\]/g, function replacer(match, $1) {\n        return (qns[qi].evda[$1.trim()] == undefined ? $1.trim() : (qns[qi].evda[$1.trim()] + \"\").trim());\n      });\n\n      //equation\n      qns[qi].steps[k].eqn = qns[qi].steps[k].eqn.replace(/(\\w+)/g, function replacer(match, $1) {\n        return (qns[qi].evda[$1.trim()] == undefined ? $1.trim() : (qns[qi].evda[$1.trim()] + \"\").trim());\n      });\n    } //end of for\n  } //end of if\n}\n\n/**\n * getQnsByUserId\n */\nexport function getQnsBySearchParams(req, res) {\n  var searchObj = {};\n  var exclude = \"-evhi -mthi -anhi\";\n  var fieldName = req.query.field;\n  var fieldValue = req.query.value;\n  searchObj[fieldName] = fieldValue;\n  return Question.find(searchObj, exclude).exec()\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\n// Deletes a Category from the DB\n/*\nexport function destroyQn(req, res) {\n  return Question.findById(req.params.id).exec()\n    .then(handleEntityNotFound(res))\n    .then(removeEntity(res))\n    .catch(handleError(res));\n}\n*/\n\n// Creates a new Contact in the DB\nexport function create(req, res) {\n  console.log('qn post data...' + JSON.stringify(req.body));\n  return Question.create(req.body)\n    .then(respondWithResult(res, 201))\n    .catch(handleError(res));\n}\n\n// Upserts the given Contact in the DB at the specified ID\nexport function upsert(req, res) {\n\tconsole.log('qn upsert...' + req.body._id);\n//  if(req.body._id) {\n //   delete req.body._id;\n // }\n  return Question.findOneAndUpdate({_id: req.body._id}, req.body, {new: true, upsert: true, setDefaultsOnInsert: true, runValidators: true}).exec()\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\n/*\nexport function postQn(req, res) {\n\t\tconsole.log('qn post...' + req.body._id);\n\t\tvar qn = new Question(req.body);\n\t\ttry {\n\t\t\tqn.save(function (err, result) {\n\t\t\t\tif (err) {\n\t\t\t\t\tconsole.log('qn post error...' + req.body._id);\n\t\t\t\t\tres.send(err);\n\t\t\t\t}\n\t\t\t\tconsole.log('qn post success...', result);\n\t\t\t\tres.json(result);\n\t\t\t});\n\t\t}\n\t\tcatch (e) {\n\t\t\tconsole.log('qn post exception...' + JSON.stringify(e));\n\t\t}\n}\n\n//////////////////////////PUT PUT //////////////////////////////////////////////\nexport function putQn(req, res) {\n\t\tconsole.log('qn update id..' + req.body._id);\n\t\tvar query = {}, options = { upsert: true, new: true };\n\t\t// Find the document\n\t\tQuestion.findOneAndUpdate({ _id: req.body._id }, req.body, options, function (error, result) {\n\t\t\tif (error) {\n\t\t\t\tres.send(500, { error: error });\n\t\t\t}\n\t\t\tresult.anhi = undefined;\n\t\t\tresult.evhi = undefined;\n\t\t\tres.json(result);\n\t\t});\n}\n*/\n////////////////////////////DELETE//////////////////////////////////////\nexport function deleteQn(req, res) {\n\t\tconsole.log('qn delete......', JSON.stringify(req.body));\n\t\tvar qn = new Question(req.body);\n\t\tqn.remove({\n\t\t\t_id: req.body._id\n\t\t}, function (err, Question) {\n\t\t\tif (err)\n\t\t\t\tres.send(err);\n\t\t\tres.json({ message: 'Successfully deleted' });\n\t\t});\n}\n\n\n\n\n\n//export function upsertQn(req, res) {\n\n//}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"]}